<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Administração de Destinos de Transporte</title>
    <style>
        body { font-family: Arial, sans-serif; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
        th { background: #ececec; }
        input[type="text"], input[type="number"] { width: 80px; }
        .actions button { margin: 0 2px; }
        #json-select { margin-bottom: 10px; }
        .file-section { margin-bottom: 18px; }
        .msg { color: green; margin-left: 10px;}
        .err { color: #b90000; }
        .warn { color: #b90000; font-size: 90%;}
        .conversion-section { margin: 20px 0 10px 0; background: #f6f6f6; padding: 10px; border-radius: 6px;}
        .conversion-section label { margin-right: 10px; }
    </style>
</head>
<body>
    <h2>Administração de Destinos de Transporte</h2>
    <div class="file-section">
        <label for="json-select">Selecionar ficheiro:</label>
        <select id="json-select">
            <option value="xbslog_nacional.json">xbslog_nacional.json</option>
            <option value="xbslog_international.json">xbslog_international.json</option>
            <option value="_new_">Criar novo ficheiro...</option>
        </select>
        <button onclick="loadJson()">Carregar</button>
        <span class="warn">(Após criar novo ficheiro, não te esqueças de descarregar e subir ao repositório!)</span>
    </div>
    <div id="table-container"></div>
    <div style="margin-top:12px">
        <button onclick="addRow()">Adicionar novo destino</button>
        <button onclick="downloadJson()">Descarregar JSON</button>
        <button onclick="addEscalao()">Adicionar novo escalão/coluna</button>
        <span id="msg" class="msg"></span>
    </div>
    <div id="conversion-container"></div>
    <script>
        let currentJson = null;
        let currentFilename = '';
        let allPriceKeys = [];

        function loadJson() {
            const select = document.getElementById('json-select');
            const file = select.value;
            clearMsg();
            if (file === '_new_') {
                const nome = prompt('Nome do novo ficheiro (ex: novo_ficheiro.json):');
                if (!nome || !nome.endsWith('.json')) {
                    alert('Nome inválido. O nome deve terminar em .json');
                    select.value = "xbslog_nacional.json";
                    return;
                }
                currentFilename = nome;
                currentJson = {
                    name: nome.replace('.json',''),
                    type: '',
                    destinations: [{
                        country: '',
                        code: '',
                        name: '',
                        rates: {}
                    }],
                    conversion: {
                        m3: "",
                        LDM: ""
                    }
                };
                allPriceKeys = [];
                renderTable();
                renderConversion();
                return;
            }
            currentFilename = file;
            fetch('Tables/' + file)
                .then(r => {
                    if (!r.ok) throw new Error("Ficheiro não encontrado.");
                    return r.json()
                })
                .then(data => {
                    currentJson = data;
                    // Garante pelo menos 1 destino
                    if (!Array.isArray(currentJson.destinations) || currentJson.destinations.length === 0) {
                        currentJson.destinations = [{
                            country: '',
                            code: '',
                            name: '',
                            rates: {}
                        }];
                    }
                    // Garante bloco de conversão
                    if (!currentJson.conversion) {
                        currentJson.conversion = { m3: "", LDM: "" };
                    }
                    renderTable();
                    renderConversion();
                })
                .catch(err => {
                    document.getElementById('table-container').innerHTML = '<p style="color:red;">Erro ao carregar o ficheiro: ' + err.message + '</p>';
                    document.getElementById('conversion-container').innerHTML = '';
                    currentJson = null;
                });
        }

        function renderTable() {
            const container = document.getElementById('table-container');
            if (!currentJson || !Array.isArray(currentJson.destinations)) {
                container.innerHTML = '<p>Nenhum dado carregado.</p>';
                return;
            }

            // Descobrir todos os escalões de preços existentes no ficheiro!
            const allKeys = new Set();
            currentJson.destinations.forEach(dest => {
                if (dest.rates)
                    Object.keys(dest.rates).forEach(k => allKeys.add(k));
            });
            allPriceKeys = Array.from(allKeys);

            // Cabeçalho
            let html = '<table><tr>';
            html += '<th>País</th><th>Código</th><th>Nome</th>';
            allPriceKeys.forEach(key => html += `<th>${key}</th>`);
            html += '<th class="actions">Ações</th></tr>';

            // Linhas
            currentJson.destinations.forEach((dest, idx) => {
                html += `<tr>
                    <td><input type="text" value="${dest.country ?? ''}" onchange="editCell(${idx},'country',this.value)"></td>
                    <td><input type="text" value="${dest.code ?? ''}" onchange="editCell(${idx},'code',this.value)"></td>
                    <td><input type="text" value="${dest.name ?? ''}" onchange="editCell(${idx},'name',this.value)"></td>`;
                allPriceKeys.forEach(key => {
                    let val = '';
                    if (dest.rates && dest.rates[key] !== undefined) val = dest.rates[key];
                    html += `<td><input type="text" pattern="^[0-9]+(\\.[0-9]+)?$" value="${val}" onchange="editRate(${idx},'${key}',this.value)" oninput="this.value=this.value.replace(/[^0-9.]/g,'')"></td>`;
                });
                html += `<td class="actions">`;
                if (currentJson.destinations.length > 1) {
                    html += `<button onclick="removeRow(${idx})">Apagar</button>`;
                }
                html += `</td></tr>`;
            });

            html += '</table>';
            container.innerHTML = html;
        }

        function renderConversion() {
            const container = document.getElementById('conversion-container');
            if (!currentJson || !currentJson.conversion) {
                container.innerHTML = '';
                return;
            }
            let html = `<div class="conversion-section">
                <b>Conversão (final do ficheiro):</b>
                <label>M3: <input id="conv-m3" type="number" value="${currentJson.conversion.m3 ?? ''}" step="any" onchange="editConversion('m3', this.value)"></label>
                <label>LDM: <input id="conv-ldm" type="number" value="${currentJson.conversion.LDM ?? ''}" step="any" onchange="editConversion('LDM', this.value)"></label>
            </div>`;
            container.innerHTML = html;
        }

        function editCell(idx, field, value) {
            currentJson.destinations[idx][field] = value;
        }

        function editRate(idx, rate, value) {
            if (!currentJson.destinations[idx].rates) currentJson.destinations[idx].rates = {};
            // Aceita valor vazio (remove o escalão)
            if (value === '') delete currentJson.destinations[idx].rates[rate];
            else currentJson.destinations[idx].rates[rate] = value;
        }

        function removeRow(idx) {
            // Só permite apagar se houver mais de 1 destino!
            if (currentJson.destinations.length <= 1) {
                alert('Pelo menos um destino tem de existir!');
                return;
            }
            if (confirm('Deseja remover este destino?')) {
                currentJson.destinations.splice(idx, 1);
                renderTable();
            }
        }

        function addRow() {
            const emptyRates = {};
            allPriceKeys.forEach(key => { emptyRates[key] = ''; });
            currentJson.destinations.push({
                country: '',
                code: '',
                name: '',
                rates: emptyRates
            });
            renderTable();
        }

        function downloadJson() {
            clearMsg();
            if (!currentJson) {
                showErr("Nada para exportar!");
                return;
            }
            // Validação antes de exportar!
            for (let i=0; i<currentJson.destinations.length; i++) {
                const d = currentJson.destinations[i];
                if (!d.country || d.country.trim() === '') {
                    showErr(`Linha ${i+1}: País não pode ficar vazio.`);
                    return;
                }
                if (!d.code || d.code.trim() === '') {
                    showErr(`Linha ${i+1}: Código não pode ficar vazio.`);
                    return;
                }
                if (!d.rates || Object.keys(d.rates).length === 0) {
                    showErr(`Linha ${i+1}: Pelo menos um escalão é obrigatório.`);
                    return;
                }
                for (const key of allPriceKeys) {
                    if (d.rates[key] === undefined || d.rates[key] === '') {
                        showErr(`Linha ${i+1}: Escalão "${key}" não pode ficar vazio.`);
                        return;
                    }
                    // Só pode ser número válido (com ou sem ponto)
                    if (!/^[0-9]+(\.[0-9]+)?$/.test(d.rates[key])) {
                        showErr(`Linha ${i+1}: Escalão "${key}" só pode conter números e ponto.`);
                        return;
                    }
                }
            }
            const blob = new Blob([JSON.stringify(currentJson, null, 2)], {type:'application/json'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = currentFilename || 'destinos.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMsg("Ficheiro descarregado! Sobe-o manualmente para o repositório.");
        }

        function addEscalao() {
            let novaCol = prompt('Nome do novo escalão/coluna (ex: "1001-2000" ou "minimum")');
            if (!novaCol) return;
            novaCol = novaCol.trim();
            if (!novaCol) return;
            if (allPriceKeys.includes(novaCol)) {
                alert("Esse escalão já existe!");
                return;
            }
            allPriceKeys.push(novaCol);
            currentJson.destinations.forEach(dest => {
                if (!dest.rates) dest.rates = {};
                dest.rates[novaCol] = '';
            });
            renderTable();
        }

        function editConversion(field, value) {
            if (!currentJson.conversion) currentJson.conversion = {};
            currentJson.conversion[field] = isNaN(value) || value.trim() === '' ? value : Number(value);
        }

        function showMsg(msg) {
            document.getElementById('msg').textContent = msg;
            document.getElementById('msg').className = "msg";
            setTimeout(()=>{clearMsg()},4000);
        }
        function showErr(msg) {
            document.getElementById('msg').textContent = msg;
            document.getElementById('msg').className = "err";
        }
        function clearMsg() {
            document.getElementById('msg').textContent = "";
            document.getElementById('msg').className = "msg";
        }
    </script>
</body>
</html>
