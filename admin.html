<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Administração de Destinos de Transporte</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .scroll-table { overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; min-width: 900px; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
        th { background: #ececec; }
        input[type="text"], input[type="number"] {
            width: 80px;
            font-size: 17px;
        }
        .actions {
            width: 170px;
            min-width: 170px;
            max-width: 170px;
        }
        .actions button { margin: 0 2px; }
        #json-select { margin-bottom: 10px; }
        .file-section { margin-bottom: 18px; }
        .msg { color: green; margin-left: 10px;}
        .err { color: #b90000; }
        .warn { color: #b90000; font-size: 90%;}
        .conversion-section { margin: 20px 0 10px 0; background: #f6f6f6; padding: 10px; border-radius: 6px;}
        .conversion-section label { margin-right: 10px; }
        .readonly input { background: #f5f5f5; border: none; }
        .conversion-actions { display: inline-block; margin-left: 10px; }
        .conversion-section input { font-size: 17px; }

        /* Autocomplete styles */
        .autocomplete-items { border-radius: 4px; position: absolute; z-index: 1001; background: white; border: 1px solid #ccc; max-height: 180px; overflow-y: auto; }
        .autocomplete-items div { padding: 6px; cursor: pointer; }
        .autocomplete-items div:hover, .autocomplete-active { background: #e0e0ff; }
    </style>
</head>
<body>
    <h2>Administração de Destinos de Transporte</h2>
    <div class="file-section">
        <label for="json-select">Selecionar ficheiro:</label>
        <select id="json-select"></select>
        <button onclick="loadJson()">Carregar</button>
        <span class="warn">(Após criar novo ficheiro, não te esqueças de descarregar e subir ao repositório!)</span>
    </div>
    <div class="scroll-table"><div id="table-container"></div></div>
    <div style="margin-top:12px">
        <button onclick="addRow()">Adicionar novo destino</button>
        <button onclick="downloadJson()">Descarregar JSON</button>
        <button onclick="addEscalao()">Adicionar novo escalão/coluna</button>
        <span id="msg" class="msg"></span>
    </div>
    <div id="conversion-container"></div>

    <!-- Inclui autocomplete de países -->
    <script>
        // Lista de países permitidos
        const PAISES_LIST = [
          "Albania","Alemanha","Andorra","Armenia","Austria","Azerbaijão","Belgica","Bielorrussia",
          "Bosnia e Herzegovina","Bulgaria","Chequia","Chipre","Croacia","Dinamarca","Eslovania",
          "Eslovaquia","Espanha","Estonia","Finlandia","França","Georgia","Grecia","Hungria",
          "Irlanda","Islandia","Italia","Kosovo","Letonia","Liechtenstein","Lituania","Luxemburgo",
          "Macedonia do Norte","Malta","Moldavia","Montenegro","Noruega","Paises Baixos","Polonia",
          "Portugal","Reino Unido","Roménia","Russia","San Marino","Servia","Suecia","Suiça",
          "Turquia","Ucrania"
        ];

        // Função para associar autocomplete ao input, agora dropdown flutuante
        function attachCountryAutocomplete(input) {
          let currentFocus;
          input.setAttribute("autocomplete", "off");

          input.addEventListener("input", function() {
            closeAllLists();
            const val = this.value;
            if (!val) return false;
            currentFocus = -1;

            // Cria o container da lista NO BODY para ser flutuante!
            const listDiv = document.createElement("div");
            listDiv.setAttribute("class", "autocomplete-items");
            listDiv.style.position = "absolute";
            // Calcula posição do input na página
            const rect = input.getBoundingClientRect();
            listDiv.style.left = rect.left + window.scrollX + "px";
            listDiv.style.top = rect.bottom + window.scrollY + "px";
            listDiv.style.width = rect.width + "px";
            document.body.appendChild(listDiv);

            // Filtra e mostra as sugestões
            const valNorm = val.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            let count = 0;
            for (let pais of PAISES_LIST) {
              const paisNorm = pais.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
              if (paisNorm.startsWith(valNorm)) {
                const itemDiv = document.createElement("div");
                itemDiv.innerHTML = "<strong>" + pais.substr(0, val.length) + "</strong>" + pais.substr(val.length);
                itemDiv.innerHTML += `<input type='hidden' value='${pais}'>`;
                itemDiv.addEventListener("click", function() {
                  input.value = this.getElementsByTagName("input")[0].value;
                  closeAllLists();
                  input.dispatchEvent(new Event("change"));
                });
                listDiv.appendChild(itemDiv);
                count++;
              }
            }
            if (count === 0) {
              const itemDiv = document.createElement("div");
              itemDiv.innerHTML = "<span style='color:#999'>Nenhum país encontrado</span>";
              listDiv.appendChild(itemDiv);
            }
          });

          // Navegação por teclas
          input.addEventListener("keydown", function(e) {
            let lists = document.querySelectorAll(".autocomplete-items");
            if (lists.length === 0) return;
            let list = lists[lists.length-1].getElementsByTagName("div");
            if (e.key === "ArrowDown") {
              currentFocus++;
              addActive(list);
            } else if (e.key === "ArrowUp") {
              currentFocus--;
              addActive(list);
            } else if (e.key === "Enter") {
              e.preventDefault();
              if (list && currentFocus > -1) {
                list[currentFocus].click();
              }
            }
          });

          function addActive(list) {
            if (!list) return false;
            removeActive(list);
            if (currentFocus >= list.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = list.length - 1;
            list[currentFocus].classList.add("autocomplete-active");
            list[currentFocus].scrollIntoView({ block: "nearest" });
          }
          function removeActive(list) {
            for (let i = 0; i < list.length; i++) {
              list[i].classList.remove("autocomplete-active");
            }
          }
          function closeAllLists(elmnt) {
            const lists = document.querySelectorAll(".autocomplete-items");
            for (let div of lists) {
              if (elmnt !== div && elmnt !== input) div.parentNode.removeChild(div);
            }
          }
          document.addEventListener("click", function(e) {
            closeAllLists(e.target);
          });
        }

        // Função para validar se o valor está na lista de países (exato)
        function isPaisValido(valor) {
          return PAISES_LIST.includes(valor);
        }
    </script>

    <script>
        // ... restante do seu código JS permanece igual ...
        // Não é necessário alterar nada abaixo desta linha!
        // (O autocomplete de países já está corrigido para flutuar sobre a tabela)
        // (A função renderTable já chama attachCountryAutocomplete)
        // (A validação já está feita via isPaisValido)
        // ... (resto do código igual ao anterior, não mostrado por brevidade) ...
    </script>
</body>
</html>
