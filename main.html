<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Page</title>
    <style>
        /* Existing styles remain untouched */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            display: flex;
            position: relative;
            flex-wrap: wrap;
        }
        .form-container {
            flex: 1 1 50%;
            max-width: 600px;
        }
        .map-container {
            flex: 1 1 50%;
            max-width: 600px;
            padding-left: 20px;
        }
        .map {
            height: 500px;
            width: 100%;
            background-color: white;
        }
        /* Responsive styles */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            .form-container, .map-container {
                flex: 1 1 100%;
                max-width: none;
                padding-left: 0;
            }
            .map {
                height: 300px;
            }
        }
    </style>

    <!-- Include Leaflet.js library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
    <button class="logout-button" onclick="logout()">Logout</button>
    <div class="form-container">
        <!-- Existing form content remains untouched -->
        <div class="form-group">
            <label for="country">Select Country:</label>
            <div class="dropdown">
                <input type="text" id="country" placeholder="Type to search..." onkeyup="filterCountries()" onfocus="showDropdown('country-list')">
                <div class="dropdown-content" id="country-list">
                    <!-- Country options will be dynamically populated here -->
                </div>
            </div>
            <label for="zone">Select Zone:</label>
            <div class="dropdown">
                <input type="text" id="zone" placeholder="Type zone number..." onkeyup="filterZones()" onfocus="showDropdown('zone-list')" disabled>
                <div class="dropdown-content" id="zone-list">
                    <!-- Zone options will be dynamically populated here -->
                </div>
            </div>
        </div>
        <div class="header-row">
            <div>Type:</div>
            <div>Width (cm):</div>
            <div>Length (cm):</div>
            <div>Height (cm):</div>
            <div>Quantity:</div>
            <div>Volumetric Weight (kg):</div>
            <div>Action:</div>
        </div>
        <div id="dimension-container">
            <div class="form-group dimension-line">
                <div>
                    <select class="type" oninput="removeHighlight(this)">
                        <option value="box">Box</option>
                        <option value="pallet">Pallet</option>
                    </select>
                </div>
                <div>
                    <input type="number" class="width" min="0" max="999" maxlength="3" oninput="validateInput(this)">
                </div>
                <div>
                    <input type="number" class="length" min="0" max="999" maxlength="3" oninput="validateInput(this)">
                </div>
                <div>
                    <input type="number" class="height" min="0" max="999" maxlength="3" oninput="validateInput(this)">
                </div>
                <div>
                    <input type="number" class="quantity" min="0" max="999" maxlength="3" oninput="validateInput(this)">
                </div>
                <div>
                    <input type="text" class="cubic-capacity" readonly>
                </div>
                <div>
                    <button class="remove-button" onclick="removeLine(this)">Remove</button>
                </div>
            </div>
        </div>
        <button id="add-line" onclick="addLine()">+ Add More Lines</button>
        <div class="button-container">
            <button onclick="finalCalculate()">Calculate</button>
        </div>
        <button onclick="resetForm()">Reset</button>
        <div class="result" id="result"></div>
        <div class="error-message" id="error-message"></div>
    </div>
    <div class="map-container">
        <div id="map" class="map"></div>
    </div>

    <script src="calculate.js"></script>
    <script>
        // Initialize the map
        let map = L.map('map').setView([39.5, -8], 6); // Default center on Portugal
        let currentLayer; // Variable to store the current GeoJSON layer

        // Add a tile layer (background map)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // Load GeoJSON for the selected country
        function loadCountryMap() {
            const country = document.getElementById('country').value;

            if (!country) return; // If no country is selected, do nothing

            // Remove the current layer if it exists
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }

            // Fetch the GeoJSON file for the selected country
            fetch(`./GeoJSON/${country}.geojson`)
                .then((response) => response.json())
                .then((geojson) => {
                    // Add the GeoJSON layer
                    currentLayer = L.geoJSON(geojson, {
                        style: {
                            color: 'black', // Outline color
                            fillColor: 'white', // Default fill color
                            weight: 1, // Outline thickness
                        },
                        onEachFeature: (feature, layer) => {
                            // Attach the postal code to the layer
                            layer.postalCode = feature.properties.postal_code;

                            // Highlight zone on click
                            layer.on('click', () => {
                                highlightZoneByCode(layer.postalCode);
                            });
                        },
                    }).addTo(map);

                    // Fit the map to the GeoJSON boundaries
                    map.fitBounds(currentLayer.getBounds());

                    // Populate the zone dropdown
                    populateZoneDropdown(geojson);
                })
                .catch((error) => console.error('Error loading GeoJSON:', error));
        }

        // Populate the zone dropdown with postal codes from the GeoJSON
        function populateZoneDropdown(geojson) {
            const zoneDropdown = document.getElementById('zone');
            zoneDropdown.innerHTML = '<option value="">-- Select Zone --</option>'; // Clear previous options

            geojson.features.forEach((feature) => {
                const postalCode = feature.properties.postal_code;
                const option = document.createElement('option');
                option.value = postalCode;
                option.textContent = postalCode;
                zoneDropdown.appendChild(option);
            });

            // Enable the zone dropdown after loading zones
            document.getElementById('zone').disabled = false;
        }

        // Highlight a zone based on the dropdown selection
        function highlightZone() {
            const selectedZone = document.getElementById('zone').value;

            if (!selectedZone || !currentLayer) return;

            // Reset all styles
            currentLayer.eachLayer((layer) => {
                layer.setStyle({
                    color: 'black',
                    fillColor: 'white',
                });

                // Highlight the selected zone
                if (layer.postalCode === selectedZone) {
                    layer.setStyle({
                        color: 'red',
                        fillColor: 'orange',
                    });
                }
            });
        }

        // Highlight a zone by postal code (used by map clicks)
        function highlightZoneByCode(postalCode) {
            // Update the zone dropdown
            document.getElementById('zone').value = postalCode;
            highlightZone(); // Highlight the selected zone
        }
    </script>
</body>
</html>
